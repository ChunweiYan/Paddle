<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Python Use Case &mdash; PaddlePaddle  documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="PaddlePaddle  documentation" href="../../index.html" />
    <link rel="up" title="User Interface" href="../index.html" />
    <link rel="next" title="PyDataProviderWrapper API" href="../api/py_data_provider_wrapper.html" />
    <link rel="prev" title="DataProvider Tutorial" href="index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../api/py_data_provider_wrapper.html" title="PyDataProviderWrapper API"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="DataProvider Tutorial"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">PaddlePaddle  documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">User Interface</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="python-use-case">
<span id="python-use-case"></span><h1>Python Use Case<a class="headerlink" href="#python-use-case" title="Permalink to this headline">¶</a></h1>
<p>This tutorial guides you into using python script that converts user input data into PaddlePaddle Data Format.</p>
<div class="section" id="quick-start">
<span id="quick-start"></span><h2>Quick Start<a class="headerlink" href="#quick-start" title="Permalink to this headline">¶</a></h2>
<p>We use a custom data to show the quick usage. This data consists of two parts with semicolon-delimited <code class="docutils literal"><span class="pre">';'</span></code>: a) label with 2 dimensions, b) continuous features with 9 dimensions:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>1;0 0 0 0 0.192157 0.070588 0.215686 0.533333 0
0;0 0 0 0.988235 0.913725 0.329412 0.376471 0 0
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">simple_provider.py</span></code> defines a python data provider:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">trainer.PyDataProviderWrapper</span> <span class="kn">import</span> <span class="n">DenseSlot</span><span class="p">,</span> <span class="n">IndexSlot</span><span class="p">,</span> <span class="n">provider</span>

<span class="nd">@provider</span><span class="p">([</span><span class="n">DenseSlot</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="n">IndexSlot</span><span class="p">(</span><span class="mi">2</span><span class="p">)])</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">image</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="k">yield</span> <span class="n">label</span><span class="p">,</span> <span class="n">image</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">&#64;provider</span></code>: specify the SlotType and its dimension. Here, we have 2 Slots, DenseSlot(9) stores continuous features with 9 dimensions, and IndexSlot(2) stores label with 2 dimensions.</li>
<li><code class="docutils literal"><span class="pre">process</span></code>: a generator using <strong>yield</strong> keyword to return results one by one. Here, the return format is 1 Discrete Feature and a list of 9 float Continuous Features.</li>
</ul>
<p>The corresponding python <strong>Train</strong> data source <code class="docutils literal"><span class="pre">define_py_data_source</span></code> is:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">define_py_data_sources</span><span class="p">(</span><span class="s1">&#39;train.list&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;simple_provider&#39;</span><span class="p">,</span> <span class="s1">&#39;process&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>See <a href = "../trainer_config_helpers_api.html#trainer_config_helpers.data_sources.define_py_data_sources">here</a> for detail API reference of <code class="docutils literal"><span class="pre">define_py_data_sources</span></code>.</p>
</div>
<div class="section" id="sequence-example">
<span id="sequence-example"></span><h2>Sequence Example<a class="headerlink" href="#sequence-example" title="Permalink to this headline">¶</a></h2>
<p>In some tasks such as Natural Language Processing (NLP), the dimension of Slot is related to the dictionary size, and the dictionary should be dynamically loaded during training or generating. PyDataProviderWrapper can satisfy all these demands easily.</p>
<div class="section" id="sequence-has-no-sub-sequence">
<span id="sequence-has-no-sub-sequence"></span><h3>Sequence has no sub-sequence<a class="headerlink" href="#sequence-has-no-sub-sequence" title="Permalink to this headline">¶</a></h3>
<p>Following is an example of data provider when using LSTM network to do sentiment analysis (If you want to understand the whole details of this task, please refer to <a class="reference external" href="ui/demo/sentiment_analysis/index.md">Sentiment Analysis Tutorial</a>).</p>
<p>The input data consists of two parts with two-tabs-delimited: a) label with 2 dimensions, b) sequence with dictionary length dimensions:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>0       I saw this movie at the AFI Dallas festival . It all takes place at a lake house and it looks wonderful .
1       This documentary makes you travel all around the globe . It contains rare and stunning sequels from the wilderness .
...
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">dataprovider.py</span></code> in <code class="docutils literal"><span class="pre">demo/sentiment</span></code> is:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">trainer.PyDataProviderWrapper</span> <span class="kn">import</span> <span class="o">*</span>

<span class="nd">@init_hook_wrapper</span>
<span class="k">def</span> <span class="nf">hook</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">word_dict</span> <span class="o">=</span> <span class="n">dictionary</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">slots</span> <span class="o">=</span> <span class="p">[</span><span class="n">IndexSlot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">word_dict</span><span class="p">)),</span> <span class="n">IndexSlot</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;dict len : </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">word_dict</span><span class="p">)))</span>

<span class="nd">@provider</span><span class="p">(</span><span class="n">use_seq</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">init_hook</span><span class="o">=</span><span class="n">hook</span><span class="p">)</span>
<span class="c1"># @provider(use_seq=True, init_hook=hook, pool_size=PoolSize(5000))</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fdata</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line_count</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fdata</span><span class="p">):</span>
            <span class="n">label</span><span class="p">,</span> <span class="n">comment</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">label</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)))</span>
            <span class="n">words</span> <span class="o">=</span> <span class="n">comment</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">word_slot</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">word_dict</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span> <span class="k">if</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">word_dict</span><span class="p">]</span>
            <span class="k">yield</span> <span class="n">word_slot</span><span class="p">,</span> <span class="p">[</span><span class="n">label</span><span class="p">]</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">hook</span></code>: Initialization hook of data provider. Here, it reads the dictionary, sets the obj.slots based on the dictionary length, and uses obj.logger to output some logs.</li>
<li><code class="docutils literal"><span class="pre">process</span></code>: Here, as the Sequence Mode of input is <strong>Seq</strong> and SlotType is IndexSlot, use_seq is set to True, and the yield format is <code class="docutils literal"><span class="pre">[int,</span> <span class="pre">int,</span> <span class="pre">....]</span></code>.</li>
<li><code class="docutils literal"><span class="pre">PoolSize</span></code>: If there are a lot of data, you may need this argument to increase loading speed and reduce memory footprint. Here, PoolSize(5000) means read at most 5000 samples to memory.</li>
</ul>
<p>The corresponding python <strong>Train/Test</strong> data sources <code class="docutils literal"><span class="pre">define_py_data_sources</span></code> is:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">train_list</span> <span class="o">=</span> <span class="n">train_list</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">is_test</span> <span class="k">else</span> <span class="bp">None</span>
<span class="n">word_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dict_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">dict_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)):</span>
        <span class="n">word_dict</span><span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span> 

<span class="n">define_py_data_sources</span><span class="p">(</span><span class="n">train_list</span><span class="p">,</span> <span class="n">test_list</span><span class="p">,</span> <span class="n">module</span> <span class="o">=</span> <span class="s2">&quot;dataprovider&quot;</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="s2">&quot;processData&quot;</span><span class="p">,</span>
                       <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dictionary&#39;</span><span class="p">:</span> <span class="n">word_dict</span><span class="p">},</span> <span class="n">train_async</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="sequence-has-sub-sequence">
<span id="sequence-has-sub-sequence"></span><h3>Sequence has sub-sequence<a class="headerlink" href="#sequence-has-sub-sequence" title="Permalink to this headline">¶</a></h3>
<p>If the sequence of above input data is considered as several sub-sequences joint by dot <code class="docutils literal"><span class="pre">'.'</span></code>, quesion mark <code class="docutils literal"><span class="pre">'?'</span></code> or exclamation mark <code class="docutils literal"><span class="pre">'!'</span></code>, see <code class="docutils literal"><span class="pre">processData2</span></code> in <code class="docutils literal"><span class="pre">demo/sentiment/dataprovider.py</span></code> as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>

<span class="nd">@provider</span><span class="p">(</span><span class="n">use_seq</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">init_hook</span><span class="o">=</span><span class="n">hook</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">process2</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fdata</span><span class="p">:</span>
    <span class="n">pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;[^.?!]+[.?!]&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line_count</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fdata</span><span class="p">):</span>
        <span class="n">label</span><span class="p">,</span> <span class="n">comment</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)))</span>
        <span class="n">words_list</span> <span class="o">=</span> <span class="n">pat</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
        <span class="n">word_slot_list</span> <span class="o">=</span> <span class="p">[[</span><span class="n">obj</span><span class="o">.</span><span class="n">word_dict</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> \
                          <span class="k">if</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">word_dict</span><span class="p">]</span> <span class="k">for</span> <span class="n">words</span> <span class="ow">in</span> <span class="n">words_list</span><span class="p">]</span>
        <span class="k">yield</span> <span class="n">word_slot_list</span><span class="p">,</span> <span class="p">[[</span><span class="n">label</span><span class="p">]]</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">hook</span></code>: the same as above. Note that as <strong>SubSeq Slot must put before Seq Slot</strong> in PaddlePaddle, we could not reverse the yield order in this case.</li>
<li><code class="docutils literal"><span class="pre">process2</span></code>: Here, as the Sequence Mode of input is <strong>SubSeq</strong>, and the SlotType is IndexSlot, use_seq is set to True, and the yield format is <code class="docutils literal"><span class="pre">[[int,</span> <span class="pre">int,</span> <span class="pre">...],</span> <span class="pre">[int,</span> <span class="pre">int,</span> <span class="pre">...],</span> <span class="pre">...</span> <span class="pre">]</span></code>.</li>
<li><code class="docutils literal"><span class="pre">define_py_data_sources</span></code>: the same as above.</li>
</ul>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Python Use Case</a><ul>
<li><a class="reference internal" href="#quick-start">Quick Start</a></li>
<li><a class="reference internal" href="#sequence-example">Sequence Example</a><ul>
<li><a class="reference internal" href="#sequence-has-no-sub-sequence">Sequence has no sub-sequence</a></li>
<li><a class="reference internal" href="#sequence-has-sub-sequence">Sequence has sub-sequence</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">DataProvider Tutorial</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../api/py_data_provider_wrapper.html"
                        title="next chapter">PyDataProviderWrapper API</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/ui/data_provider/python_case.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../api/py_data_provider_wrapper.html" title="PyDataProviderWrapper API"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="DataProvider Tutorial"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">PaddlePaddle  documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >User Interface</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2016, PaddlePaddle developers.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.5.
    </div>
  </body>
</html>